From ffbeae77985607173b2077fe15fdd07eda8d8f6e Mon Sep 17 00:00:00 2001
From: Jason Furmanek <furmanek@us.ibm.com>
Date: Tue, 6 Apr 2021 15:00:01 -0500
Subject: [PATCH] TF Build fix ppc64le

---
 WORKSPACE                                       |   1 +
 third_party/tensorflow/BUILD                    |   0
 third_party/tensorflow/tensorflow_patches.patch | 114 ++++++++++++++++++++++++
 3 files changed, 115 insertions(+)
 create mode 100644 third_party/tensorflow/BUILD
 create mode 100644 third_party/tensorflow/tensorflow_patches.patch

diff --git a/WORKSPACE b/WORKSPACE
index 34ce956..e135652 100644
--- a/WORKSPACE
+++ b/WORKSPACE
@@ -13,6 +13,7 @@ tensorflow_http_archive(
     name = "org_tensorflow",
     sha256 = "ac2d19cf529f9c2c9faaf87e472d08a2bdbb2ab058958e2cafd65e5eb0637b2b",
     git_commit = "85c8b2a817f95a3e979ecd1ed95bff1dc1335cff",
+    patch = "//third_party/tensorflow:tensorflow_patches.patch",
 )
 
 load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
diff --git a/third_party/tensorflow/BUILD b/third_party/tensorflow/BUILD
new file mode 100644
index 0000000..e69de29
diff --git a/third_party/tensorflow/tensorflow_patches.patch b/third_party/tensorflow/tensorflow_patches.patch
new file mode 100644
index 0000000..6828d1c
--- /dev/null
+++ b/third_party/tensorflow/tensorflow_patches.patch
@@ -0,0 +1,114 @@
+From 4180c728e0a4caffd2e38131d7f459cb8ab0637f Mon Sep 17 00:00:00 2001
+From: Jason Furmanek <furmanek@us.ibm.com>
+Date: Tue, 6 Apr 2021 14:47:49 -0500
+Subject: [PATCH] tensorflow patches
+
+---
+ tensorflow/stream_executor/cuda/BUILD       |  2 +-
+ tensorflow/workspace.bzl                    |  8 ++++----
+ third_party/gpus/cuda_configure.bzl         | 29 +++++++++++++++++++++++++++++
+ third_party/tensorrt/tensorrt_configure.bzl |  1 +
+ 4 files changed, 35 insertions(+), 5 deletions(-)
+
+diff --git a/tensorflow/stream_executor/cuda/BUILD b/tensorflow/stream_executor/cuda/BUILD
+index 7086217..9cdd1ee 100644
+--- a/tensorflow/stream_executor/cuda/BUILD
++++ b/tensorflow/stream_executor/cuda/BUILD
+@@ -271,7 +271,7 @@ alias(
+     name = "cublas_lt_lib",
+     actual = select({
+         "//tensorflow:oss": ":cublas_lt_stub",
+-        "//conditions:default": ":empty_lib",
++        "//conditions:default": "@local_config_cuda//cuda:cublasLt",
+     }),
+     visibility = ["//visibility:public"],
+ )
+diff --git a/tensorflow/workspace.bzl b/tensorflow/workspace.bzl
+index 89062b1..386d94c 100755
+--- a/tensorflow/workspace.bzl
++++ b/tensorflow/workspace.bzl
+@@ -198,11 +198,11 @@ def tf_repositories(path_prefix = "", tf_repo_name = ""):
+         name = "eigen_archive",
+         build_file = clean_dep("//third_party:eigen.BUILD"),
+         patch_file = clean_dep("//third_party/eigen3:gpu_packet_math.patch"),
+-        sha256 = "e807a6a6f3a0e8ab10adeb59bb5a9bbb113e8e1684f9b4b32f73f58fd758b4cf",  # SHARED_EIGEN_SHA
+-        strip_prefix = "eigen-011e0db31d1bed8b7f73662be6d57d9f30fa457a",
++        sha256 = "5b6c58d367794c76b5ad54effc60d295450958f98b7506966a29d0e45d7b066d",  # SHARED_EIGEN_SHA
++        strip_prefix = "libeigen-eigen-revert-matrix-enhance",
+         urls = [
+-            "https://storage.googleapis.com/mirror.tensorflow.org/gitlab.com/libeigen/eigen/-/archive/011e0db31d1bed8b7f73662be6d57d9f30fa457a/eigen-011e0db31d1bed8b7f73662be6d57d9f30fa457a.tar.gz",
+-            "https://gitlab.com/libeigen/eigen/-/archive/011e0db31d1bed8b7f73662be6d57d9f30fa457a/eigen-011e0db31d1bed8b7f73662be6d57d9f30fa457a.tar.gz",
++            "https://storage.googleapis.com/mirror.tensorflow.org/github.com/open-ce/libeigen-eigen/archive/revert-matrix-enhance.zip",
++            "https://github.com/open-ce/libeigen-eigen/archive/revert-matrix-enhance.zip",
+         ],
+     )
+ 
+diff --git a/third_party/gpus/cuda_configure.bzl b/third_party/gpus/cuda_configure.bzl
+index 3ba3447..e272a28 100644
+--- a/third_party/gpus/cuda_configure.bzl
++++ b/third_party/gpus/cuda_configure.bzl
+@@ -51,6 +51,7 @@ load(
+     "read_dir",
+     "realpath",
+     "which",
++    "files_exist",
+ )
+ 
+ _GCC_HOST_COMPILER_PATH = "GCC_HOST_COMPILER_PATH"
+@@ -330,6 +331,30 @@ def auto_configure_fail(msg):
+ 
+ # END cc_configure common functions (see TODO above).
+ 
++# TODO: Below code isn't tested with platforms other than linux ppc64le and x86_64
++def _get_cuda_extra_target_path(repository_ctx, cuda_config): 
++    cuda_extra_path = ""
++    if cuda_config.cpu_value == "Linux":
++        os_name = "linux"
++
++    cpu = "x86_64"
++    machine_type = repository_ctx.execute(["bash", "-c", "uname -p"]).stdout
++    if (machine_type.startswith("ppc") or
++        machine_type.startswith("powerpc")):
++        cpu = "ppc64le"
++    elif machine_type.startswith("s390x"):
++        cpu = "s390x"
++    elif machine_type.startswith("aarch64"):
++        cpu = "aarch64"
++    elif machine_type.startswith("arm"):
++        cpu = "arm"
++    
++    extra_path = cuda_config.cuda_toolkit_path + "/targets/" + cpu + "-" + os_name + "/include"
++    if files_exist(repository_ctx, [extra_path]) == [True]:
++        cuda_extra_path = realpath(repository_ctx, extra_path)
++    
++    return cuda_extra_path
++   
+ def _cuda_include_path(repository_ctx, cuda_config):
+     """Generates the Starlark string with cuda include directories.
+ 
+@@ -362,6 +387,10 @@ def _cuda_include_path(repository_ctx, cuda_config):
+     if target_dir != "":
+         inc_entries.append(realpath(repository_ctx, target_dir))
+     inc_entries.append(realpath(repository_ctx, cuda_config.cuda_toolkit_path + "/include"))
++
++    extra_cuda_path = _get_cuda_extra_target_path(repository_ctx, cuda_config)
++    if extra_cuda_path != "":
++        inc_entries.append(extra_cuda_path)
+     return inc_entries
+ 
+ def enable_cuda(repository_ctx):
+diff --git a/third_party/tensorrt/tensorrt_configure.bzl b/third_party/tensorrt/tensorrt_configure.bzl
+index 9c980a9..fe1830f 100644
+--- a/third_party/tensorrt/tensorrt_configure.bzl
++++ b/third_party/tensorrt/tensorrt_configure.bzl
+@@ -101,6 +101,7 @@ def _create_local_tensorrt_repository(repository_ctx):
+ 
+     # Copy the library and header files.
+     libraries = [lib_name(lib, cpu_value, trt_version) for lib in _TF_TENSORRT_LIBS]
++    libraries.append("libmyelin.so.1")
+     library_dir = config["tensorrt_library_dir"] + "/"
+     headers = _get_tensorrt_headers(trt_version)
+     include_dir = config["tensorrt_include_dir"] + "/"
+-- 
+1.8.3.1
+
-- 
1.8.3.1

